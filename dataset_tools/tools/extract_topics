#!/usr/bin/python

import rospy
import rosbag
import os
import sys
import argparse

def extract_topics(inbag):
    rospy.loginfo('   Processing input bagfile: %s', inbag)

    for topic, msg, t in rosbag.Bag(inbag,'r').read_messages():
        if topic in ["/barometric_pressure",
                "/husky/cmd_vel",
                "/encoder",
                "/imu/data",
                "/imu/mag",
                "/imu/rpy",
                "/imu/temperature",
                "/navsat/enu_datum",
                "/navsat/enu",
                "/navsat/fix",
                "/navsat/vel",
                "/husky/data/power_status",
                "/husky/data/system_status"]:
            # save message to file
            outfilename = "topics/%s.topic" % topic[1:].replace("/","_")
            with open(outfilename, "a") as f:
                f.write("%s\n---\n" % msg)
        elif topic in ["/camera/stereo/left/image_color/compressed",
                "/camera/stereo/right/image_color/compressed",
                "/camera/starboard/image_raw/compressed",
                "/camera/rear/image_raw/compressed",
                "/camera/port/image_raw/compressed",
                "/camera/upward/image_raw/compressed",
                "/lidar/front/scan",
                "/lidar/top/scan"]:
            # save just the header to the file
            outfilename = "topics/%s_header.topic" % topic[1:].replace("/","_")
            with open(outfilename, "a") as f:
                f.write("%s\n---\n" % msg.header)
    rospy.loginfo('Closing output bagfile and exit...')

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='extracts the topics from the bagfile and saves them to individual files')
    parser.add_argument('-i', metavar='INPUT_BAGFILE', required=True, help='input bagfile')
    args = parser.parse_args()

    try:
        extract_topics(args.i)
    except Exception, e:
        import traceback
        traceback.print_exc()
